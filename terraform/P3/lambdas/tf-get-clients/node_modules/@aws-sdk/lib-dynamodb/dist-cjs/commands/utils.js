"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.unmarshallOutput = exports.marshallInput = exports.ALL_MEMBERS = exports.ALL_VALUES = exports.SELF = void 0;
const util_dynamodb_1 = require("@aws-sdk/util-dynamodb");
exports.SELF = null;
exports.ALL_VALUES = {};
exports.ALL_MEMBERS = [];
const NEXT_LEVEL = "*";
const processObj = (obj, processFunc, keyNodes) => {
    if (obj !== undefined) {
        if (keyNodes == null) {
            return processFunc(obj);
        }
        else {
            const keys = Object.keys(keyNodes);
            const goToNextLevel = keys.length === 1 && keys[0] === NEXT_LEVEL;
            const someChildren = keys.length >= 1 && !goToNextLevel;
            const allChildren = keys.length === 0;
            if (someChildren) {
                return processKeysInObj(obj, processFunc, keyNodes);
            }
            else if (allChildren) {
                return processAllKeysInObj(obj, processFunc, exports.SELF);
            }
            else if (goToNextLevel) {
                return Object.entries(obj !== null && obj !== void 0 ? obj : {}).reduce((acc, [k, v]) => {
                    acc[k] = processObj(v, processFunc, keyNodes[NEXT_LEVEL]);
                    return acc;
                }, (Array.isArray(obj) ? [] : {}));
            }
        }
    }
    return undefined;
};
const processKeysInObj = (obj, processFunc, keyNodes) => {
    let accumulator;
    if (Array.isArray(obj)) {
        accumulator = [...obj];
    }
    else {
        accumulator = { ...obj };
    }
    for (const [nodeKey, nodes] of Object.entries(keyNodes)) {
        const processedValue = processObj(obj[nodeKey], processFunc, nodes);
        if (processedValue !== undefined) {
            accumulator[nodeKey] = processedValue;
        }
    }
    return accumulator;
};
const processAllKeysInObj = (obj, processFunc, keyNodes) => {
    if (Array.isArray(obj)) {
        return obj.map((item) => processObj(item, processFunc, keyNodes));
    }
    return Object.entries(obj).reduce((acc, [key, value]) => {
        const processedValue = processObj(value, processFunc, keyNodes);
        if (processedValue !== undefined) {
            acc[key] = processedValue;
        }
        return acc;
    }, {});
};
const marshallInput = (obj, keyNodes, options) => {
    const marshallFunc = (toMarshall) => (0, util_dynamodb_1.marshall)(toMarshall, options);
    return processKeysInObj(obj, marshallFunc, keyNodes);
};
exports.marshallInput = marshallInput;
const unmarshallOutput = (obj, keyNodes, options) => {
    const unmarshallFunc = (toMarshall) => (0, util_dynamodb_1.unmarshall)(toMarshall, options);
    return processKeysInObj(obj, unmarshallFunc, keyNodes);
};
exports.unmarshallOutput = unmarshallOutput;
